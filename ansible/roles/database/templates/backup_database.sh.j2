#!/bin/bash
# Database backup script for {{ app_name }}
# Generated by Ansible

set -e

BACKUP_DIR="{{ backup_dir }}/database"
DB_NAME="{{ db_name }}"
DB_USER="{{ db_user }}"
RETENTION_DAYS="{{ db_backup_retention_days }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${TIMESTAMP}.sql.gz"

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

# Perform database backup
echo "Starting backup of ${DB_NAME} at $(date)"
pg_dump -U "${DB_USER}" -h localhost "${DB_NAME}" | gzip > "${BACKUP_FILE}"

if [ $? -eq 0 ]; then
    echo "Backup completed successfully: ${BACKUP_FILE}"
    
    # Remove old backups
    find "${BACKUP_DIR}" -name "${DB_NAME}_*.sql.gz" -mtime +${RETENTION_DAYS} -delete
    echo "Cleaned up backups older than ${RETENTION_DAYS} days"
else
    echo "Backup failed!" >&2
    exit 1
fi

# Log backup size
BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
echo "Backup size: ${BACKUP_SIZE}"

echo "Backup completed at $(date)"