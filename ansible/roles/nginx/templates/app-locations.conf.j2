# This file should be saved as /etc/nginx/{{ app_name }}.d/locations.conf

# Frontend application
location / {
    proxy_pass http://frontend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://frontend;
        proxy_cache {{ app_name }}_cache;
        proxy_cache_valid 200 1d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
}

# Next.js specific routes
location /_next/static {
    proxy_pass http://frontend;
    proxy_cache {{ app_name }}_cache;
    proxy_cache_valid 200 365d;
    expires 365d;
    add_header Cache-Control "public, immutable";
}

location /_next/image {
    proxy_pass http://frontend;
    proxy_cache {{ app_name }}_cache;
    proxy_cache_valid 200 1d;
}

# API endpoints
location /api {
    proxy_pass http://backend;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
    
    # Rate limiting for API
    limit_req zone=api_limit burst=20 nodelay;
    
    # Disable buffering for SSE/WebSocket
    proxy_buffering off;
    proxy_request_buffering off;
}

# Django admin
location /admin {
    proxy_pass http://backend;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
}

# Django static files
location /static {
    alias {{ backend_dir }}/staticfiles;
    expires 30d;
    add_header Cache-Control "public";
}

# Django media files
location /media {
    alias {{ backend_dir }}/media;
    expires 7d;
    add_header Cache-Control "public";
}

# Health check endpoints
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

location /api/health {
    proxy_pass http://backend/api/health/;
    access_log off;
}

# Login rate limiting
location /api/auth/login {
    proxy_pass http://backend;
    limit_req zone=login_limit burst=5 nodelay;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# WebSocket support for real-time features
location /ws {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Security: Deny access to hidden files
location ~ /\. {
    deny all;
}

# Security: Deny access to backup and source files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~ {
    deny all;
}