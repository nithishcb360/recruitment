# Upstream definitions
upstream backend {
    server 127.0.0.1:{{ backend_port }} fail_timeout=0;
}

upstream frontend {
    least_conn;
    server 127.0.0.1:{{ frontend_port }} max_fails=3 fail_timeout=30s;
}

# Main server block (using port 9100 for unified access)
server {
    listen 9100;
    listen [::]:9100;
    server_name _;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    include /etc/nginx/{{ app_name }}.d/*.conf;
}